-- 특정 동물의 복약 이력 조회
-- 입력값으로 동물의 animal_id를 넣으면 복약 이력이 나옴
DELIMITER $$
CREATE OR REPLACE PROCEDURE preRecord(
	IN p_animal_id INT 
)
BEGIN
	DECLARE v_exists INT DEFAULT 0;

   -- 1. 해당 animal_id가 존재하는지 확인
   SELECT COUNT(*) INTO v_exists
   FROM Animal
   WHERE animal_id = p_animal_id;

   IF v_exists = 0 THEN
      SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT = '해당 animal_id를 가진 반려동물이 존재하지 않습니다.';
   END IF;

   -- 2. 복약 이력이 있는지 확인
   SELECT COUNT(*) INTO v_exists
   FROM prescriptionrecord
   WHERE animal_id = p_animal_id;

   IF v_exists = 0 THEN
      SIGNAL SQLSTATE '02000'
      SET MESSAGE_TEXT = '해당 동물의 복약 이력이 존재하지 않습니다.';
   END IF;

	SELECT a.name AS animal_name, s.symptom_id, d.drug_name, p.dose_given, p.notes
	FROM prescriptionrecord p
	JOIN Animal a ON p.animal_id = a.animal_id
	JOIN Drug d ON p.drug_id = d.drug_id
	JOIN Symptom s ON p.symptom_id = s.symptom_id
	-- WHERE a.user_id = 1;
	WHERE p.animal_id = p_animal_id
	ORDER BY p.notes DESC;
END$$
DELIMITER ;

CALL preRecord(1);

DROP PROCEDURE preRecord;
