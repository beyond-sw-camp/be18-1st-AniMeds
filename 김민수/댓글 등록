DELIMITER $$

CREATE PROCEDURE AddComment(
    IN p_post_id BIGINT,
    IN p_user_id INT,
    IN p_content TEXT
)
BEGIN
    DECLARE v_count INT DEFAULT 0;

    -- 게시글 존재 여부 확인
    SELECT COUNT(*) INTO v_count FROM community WHERE post_id = p_post_id;
    IF v_count = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Error: 존재하지 않는 게시글입니다.';
    END IF;

    -- 사용자 존재 여부 확인
    SELECT COUNT(*) INTO v_count FROM `User` WHERE user_id = p_user_id;
    IF v_count = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Error: 유효하지 않은 사용자입니다.';
    END IF;

    -- 댓글 내용 확인
    IF p_content IS NULL OR p_content = '' THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Error: 댓글 내용은 비어 있을 수 없습니다.';
    END IF;

    -- 댓글 삽입 (이 시점에서 트리거가 자동 실행됨)
    INSERT INTO comment (post_id, user_id, content)
    VALUES (p_post_id, p_user_id, p_content);
END $$

DELIMITER ;


DELIMITER $$

CREATE TRIGGER trg_increase_comment_count
AFTER INSERT ON comment
FOR EACH ROW
BEGIN
    UPDATE community
    SET comment_count = comment_count + 1
    WHERE post_id = NEW.post_id;
END $$

DELIMITER ;


CALL AddComment(11, 1, 'ㅋㅋㅌㅊㅁㅊ');
